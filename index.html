<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>Anonimitzador Final - Simple i R√†pid</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{margin:0;padding:1.5rem;background:#f8fafc;color:#1f2937}
    textarea{width:100%;height:200px;padding:1rem;font-size:16px;border:2px solid #e2e8f0;border-radius:12px;margin:1rem 0;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    button{padding:1rem 1.5rem;margin:.5rem;font-size:16px;border:none;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:0 4px 16px rgba(0,0,0,0.15);transition:all .2s}
    #process{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white}
    #toggle{background:linear-gradient(135deg,#10b981,#059669);color:white}
    #export{background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white}
    #export:disabled{opacity:.6;cursor:not-allowed}
    #textView{padding:1.5rem;background:white;border-radius:12px;min-height:400px;box-shadow:0 8px 32px rgba(0,0,0,0.12);line-height:1.7;font-size:16px}
    .pii{padding:4px 8px;border-radius:8px;cursor:pointer;margin:2px 1px;font-weight:700;display:inline-block;box-shadow:0 2px 8px rgba(0,0,0,0.2);transition:all .2s}
    .approved{background:#10b981;color:white;transform:scale(1)}
    .pending{background:#f59e0b;color:white}
    .rejected{background:#6b7280;color:#fff;text-decoration:line-through;opacity:.7}
    .pii:hover,.pii:active{outline:3px solid #3b82f6;transform:scale(1.05)}
    #status{padding:1.5rem;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:12px;margin:1.5rem 0;font-weight:600;color:#1e40af;border-left:5px solid #3b82f6;box-shadow:0 4px 20px rgba(59,130,246,0.2)}
    h1{font-size:2rem;text-align:center;background:linear-gradient(135deg,#1e293b,#334155);color:white;padding:1.5rem;margin:0;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.2)}
    .instructions{background:#f1f5f9;padding:1.25rem;border-radius:12px;margin:1.5rem 0;border-left:6px solid #10b981;box-shadow:0 4px 20px rgba(16,185,129,0.1)}
    .small{font-size:.9rem;color:#64748b}
  </style>
</head>
<body>
  <h1>üîí Anonimitzador Final</h1>
  
  <div class="instructions">
    <strong>üéØ √ös simple:</strong><br>
    1. Obre PDF (Adobe/Files) ‚Üí Password OK ‚Üí Ctrl+A ‚Üí Ctrl+C.<br>
    2. Enganxa aqu√≠ ‚Üí <strong>Processa</strong>.<br>
    3. <strong>Tap groc/taronja</strong> per aprovar.<br>
    4. <strong>Export MD</strong> ‚Üí comparteix segur.
  </div>

  <textarea id="textInput" placeholder="Copia tot del PDF aqu√≠... (Nom: Pere DNI: 12345678A IBAN: ES9123456789012345678901...)&#10;&#10;Exemple:&#10;Titular: Maria L√≥pez P√©rez&#10;DNI: 87654321Z&#10;Compte: ES91 2345 6789 0123 4567 8901"></textarea>
  
  <div style="text-align:center">
    <button id="process" onclick="processa()">üöÄ Processa PII</button>
    <button id="toggle" onclick="toggleMode()">üëÅÔ∏è Veure Tokens</button>
    <button id="export" onclick="exportar()" disabled>üíæ Export MD + JSON</button>
  </div>

  <div id="status">Enganxa text del PDF i clica Processa...</div>
  <div id="textView"></div>
  <div id="log" class="small"></div>

  <script>
    let textOriginal = '';
    let entities = [];
    let viewMode = 'original'; // 'original' o 'tokens'

    // Regex principals (r√†pids i precisos)
    const patterns = {
      NIF: /\b\d{8}[A-Z]\b/gi,
      NIE: /\b[XYZ]\d{7}[A-Z]\b/gi,
      IBAN: /\bES\d{2}\s?(\d{4}\s?){4}\d{2}\b/gi,
      EMAIL: /[\w\.-]+@[\w\.-]+\.\w{2,}/gi,
      PHONE: /\b[6-9]\d{8}\b/gi,
      PERSON: /(?:[Nn]om|[Tt]itular|[Cc]liente?|[Aa]lumna?):\s*([A-Z√Ä-≈∏][a-z√†-√ø\s]+[A-Z√Ä-≈∏][a-z√†-√ø\s]*)/gi
    };

    function processa() {
      textOriginal = document.getElementById('textInput').value.trim();
      
      if (!textOriginal) {
        document.getElementById('status').innerHTML = '‚ùå Enganxa text del PDF';
        return;
      }

      document.getElementById('status').innerHTML = 'üîç Detectant PII autom√†tic...';

      // Detecta totes les entitats
      entities = [];
      let tokenId = 1;
      
      Object.entries(patterns).forEach(([type, regex]) => {
        regex.lastIndex = 0;
        let match;
        while ((match = regex.exec(textOriginal)) !== null) {
          entities.push({
            id: tokenId++,
            type: type,
            start: match.index,
            end: match.index + match[0].length,
            original: match[0],
            status: type === 'PERSON' ? 'pending' : 'approved' // PERSONs per revisar
          });
        }
      });

      render();
      const pendents = entities.filter(e => e.status === 'pending').length;
      document.getElementById('status').innerHTML = 
        `‚úÖ Detectats ${entities.length} PII (${pendents} per revisar). Tap per aprovar!`;
      document.getElementById('exportBtn').disabled = pendents > 0;
    }

    function render() {
      let html = '';
      let pos = 0;
      
      // Ordena per posici√≥
      const sorted = [...entities].sort((a,b) => a.start - b.start);
      
      sorted.forEach(ent => {
        // Text abans
        html += textOriginal.slice(pos, ent.start);
        
        // Span PII
        const shown = viewMode === 'original' ? ent.original : `****${ent.type}_${String(ent.id).padStart(4,'0')}****`;
        const statusClass = ent.status;
        html += `<span class="pii ${statusClass}" data-id="${ent.id}" onclick="toggle(${ent.id})">${shown}</span>`;
        
        pos = ent.end;
      });
      
      // Text final
      html += textOriginal.slice(pos);
      
      document.getElementById('textView').innerHTML = html;
      
      // Log
      const stats = entities.reduce((acc, e) => {
        acc[e.status] = (acc[e.status] || 0) + 1;
        return acc;
      }, {});
      document.getElementById('log').innerHTML = 
        `Aprovats: ${stats.approved || 0} | Pendents: ${stats.pending || 0} | Rebutjats: ${stats.rejected || 0}`;
    }

    function toggle(id) {
      const ent = entities.find(e => e.id == id);
      if (!ent) return;
      
      // Toggle status
      if (ent.status === 'approved') ent.status = 'rejected';
      else if (ent.status === 'rejected') ent.status = 'pending';
      else ent.status = 'approved'; // pending ‚Üí approved
      
      render();
      
      // Actualitza export
      const pendents = entities.filter(e => e.status === 'pending').length;
      document.getElementById('exportBtn').disabled = pendents > 0;
      
      // Status
      const total = entities.length;
      document.getElementById('status').innerHTML = 
        `‚úÖ ${total} PII. ${pendents} pendents ‚Üí <strong>${total - pendents} llestos per exportar</strong>`;
    }

    function toggleMode() {
      viewMode = viewMode === 'original' ? 'tokens' : 'original';
      document.getElementById('toggle').innerHTML = viewMode === 'original' ? 'üëÅÔ∏è Original' : 'üîí Tokens';
      render();
    }

    function exportar() {
      const pendents = entities.filter(e => e.status === 'pending');
      if (pendents.length > 0) {
        alert(`‚ö†Ô∏è ${pendents.length} PII pendents. Revisa'ls (taronja)!`);
        return;
      }

      // Construeix MD amb tokens
      let md = textOriginal;
      const approved = entities.filter(e => e.status === 'approved');
      approved.forEach(ent => {
        const token = `****${ent.type}_${String(ent.id).padStart(4,'0')}****`;
        md = md.slice(0, ent.start) + token + md.slice(ent.end);
      });

      // 1. Export MD
      const blobMD = new Blob([md], {type: 'text/markdown;charset=utf-8'});
      downloadFile(blobMD, 'anonim-final.md');

      // 2. Export JSON mapping
      const mapping = {
        generat: new Date().toISOString(),
        totalPII: approved.length,
        mapping: approved.map(e => ({
          token: `****${e.type}_${String(e.id).padStart(4,'0')}****`,
          original: e.original,
          tipus: e.type
        }))
      };
      const blobJSON = new Blob([JSON.stringify(mapping, null, 2)], {type: 'application/json;charset=utf-8'});
      downloadFile(blobJSON, 'mapping-pii.json');

      document.getElementById('status').innerHTML = '‚úÖ Export completat! MD + JSON descarregats.';
    }

    function downloadFile(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      setTimeout(() => document.body.removeChild(a), 100);
    }
  </script>
</body>
</html>
