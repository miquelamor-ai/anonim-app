<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>üîê Anonimitzador PDF Password + 48p</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{box-sizing:border-box;font-family:system-ui,sans-serif}
    body{margin:0;padding:1rem;background:#f0f4f8}
    input,textarea{width:100%;padding:.75rem;font-size:16px;border:1px solid #ddd;border-radius:8px;margin:.5rem 0}
    button{padding:.75rem 1.5rem;margin:.25rem;font-size:16px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    button:disabled{opacity:.5;cursor:not-allowed}
    #primary{background:#4f46e5;color:white}
    #secondary{background:#6b7280;color:white}
    #textView{padding:1.5rem;background:white;border-radius:12px;min-height:400px;max-height:50vh;overflow:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .pii{padding:4px 8px;border-radius:6px;cursor:pointer;margin:1px;font-weight:bold;display:inline-block}
    .approved{background:#10b981;color:white}
    .pending{background:#f59e0b;color:white}
    .rejected{background:#6b7280;color:white;text-decoration:line-through}
    .pii:active,.pii:hover{outline:3px solid #3b82f6;transform:scale(1.02)}
    #status{padding:1rem;background:#eff6ff;border-radius:8px;margin:1rem 0;font-weight:500}
    #progress{width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;margin:1rem 0}
    #progress-bar{height:100%;background:linear-gradient(90deg,#10b981,#059669);transition:width .3s}
    .small{font-size:.875rem;color:#6b7280}
    h1,h2,h3{margin:.5rem 0;color:#1f2937}
    h1{font-size:1.5rem}
  </style>
</head>
<body>
  <h1>üîê Anonimitzador COMPLET Password + Multi-p√†gina</h1>
  
  <div>
    <input type="file" id="fileInput" accept=".pdf,.txt">
    <textarea id="textInput" placeholder="O copia text manual... (Nom: Pere DNI: 12345678A...)"></textarea>
    
    <div style="display:flex;gap:.5rem;flex-wrap:wrap">
      <button id="btnProcess" onclick="processa()">üöÄ Processa</button>
      <button id="modeBtn" onclick="toggleMode()">üëÅÔ∏è Original</button>
      <button id="exportBtn" onclick="exportar()" disabled>üíæ MD + JSON</button>
    </div>
    
    <label style="display:flex;align-items:center;gap:.5rem">
      <input type="checkbox" id="chkAllPages"> Tot el PDF (48p ~2min)
    </label>
  </div>

  <div id="status">Selecciona PDF o text...</div>
  <div id="progress" style="display:none">
    <div id="progress-bar"></div>
    <div id="progress-text" class="small"></div>
  </div>
  
  <div id="textView"></div>
  <div id="log" class="small"></div>

  <script>
    let textOriginal = '';
    let entities = [];
    let mode = 'original';
    
    const patterns = {
      NIF: /\b\d{8}[A-Z]\b/gi,
      NIE: /\b[XYZ]\d{7}[A-Z]\b/gi,
      IBAN: /\bES\d{2}\s?(\d{4}\s?){4}\d{2}\b/gi,
      EMAIL: /[\w\.-]+@[\w\.-]+\.\w+/gi,
      PHONE: /\b(6|7|9)\d{8}\b/g,
      PERSON: /(?:[Nn]om|[Tt]itular|[Cc]lient):\s*([A-Z√Ä-≈∏][\w\s√†-√ø]+)/gi
    };

    async function processa() {
      showProgress(0, 'Iniciant...');
      const file = document.getElementById('fileInput').files[0];
      const inputText = document.getElementById('textInput').value.trim();
      
      if (!file && !inputText) {
        document.getElementById('status').innerHTML = '‚ùå Selecciona PDF o text';
        return;
      }

      try {
        if (file && file.name.toLowerCase().endsWith('.txt')) {
          showProgress(20, 'Llegint TXT...');
          textOriginal = await file.text();
        } else if (file && file.name.toLowerCase().endsWith('.pdf')) {
          await processaPDFCompleto(file);
        } else {
          textOriginal = inputText;
          showProgress(100, 'Text manual carregat');
        }

        if (!textOriginal.trim()) throw new Error('Text buit');

        showProgress(70, 'üîç Detectant PII...');
        entities = detectaPII(textOriginal);
        
        render();
        const pendents = entities.filter(e => e.status === 'pending').length;
        showProgress(100, `‚úÖ ${entities.length} PII (${pendents} pendents). Tap per aprovar!`);
        document.getElementById('exportBtn').disabled = pendents > 0;
        
      } catch (error) {
        document.getElementById('status').innerHTML = `‚ùå Error: ${error.message}`;
        console.error(error);
      }
    }

    async function processaPDFCompleto(file) {
      showProgress(5, 'Carregant PDF...');
      const arrayBuffer = await file.arrayBuffer();
      
      // ‚úÖ SEMPRE pregunta password per PDFs (evita error)
      const password = prompt('üîê PDF? Password (deixa buit si no n\'t√©):') || '';
      
      showProgress(15, password ? 'üîì Desbloquejant...' : 'üìñ Llegint sense password...');
      
      const loadingTask = pdfjsLib.getDocument({ 
        data: arrayBuffer,
        password: password
      });
      
      const pdf = await loadingTask.promise;
      const maxPages = document.getElementById('chkAllPages').checked ? pdf.numPages : 5;
      
      textOriginal = '';
      for (let i = 1; i <= maxPages; i++) {
        showProgress(15 + (i / maxPages) * 50, `üìÑ P√†gina ${i}/${maxPages}`);
        const page = await pdf.getPage(i);
        const content = await page.getTextContent({ normalizeWhitespace: true });
        textOriginal += content.items.map(it => it.str).join(' ') + '\n\n';
      }
      
      showProgress(65, `‚úÖ ${maxPages} p√†gines extretes`);
    }

    function detectaPII(text) {
      const list = [];
      Object.entries(patterns).forEach(([type, regex]) => {
        regex.lastIndex = 0;
        let match;
        while ((match = regex.exec(text)) !== null) {
          list.push({
            id: 'e' + Math.random().toString(36).slice(2, 8),
            type: type,
            start: match.index,
            end: match.index + match[0].length,
            text: match[0],
            status: type === 'PERSON' ? 'pending' : 'approved'
          });
        }
      });
      return list;
    }

    function render() {
      let html = '';
      let i = 0;
      const sorted = [...entities].sort((a,b) => a.start - b.start);
      
      sorted.forEach(e => {
        html += escapeHtml(textOriginal.slice(i, e.start));
        const cls = e.status;
        const shown = mode === 'original' ? e.text : `****${e.type}_${e.id.slice(2)}****`;
        html += `<span class="pii ${cls}" data-id="${e.id}" onclick="toggle('${e.id}')">${shown}</span>`;
        i = e.end;
      });
      html += escapeHtml(textOriginal.slice(i));
      
      document.getElementById('textView').innerHTML = html;
      const aprovats = entities.filter(e=>e.status==='approved').length;
      const pendents = entities.filter(e=>e.status==='pending').length;
      document.getElementById('log').innerHTML = `${aprovats} aprovats ‚Ä¢ ${pendents} pendents`;
    }

    function toggle(id) {
      const ent = entities.find(e => e.id === id);
      ent.status = ent.status === 'approved' ? 'rejected' : 'approved';
      render();
      document.getElementById('exportBtn').disabled = entities.some(e => e.status === 'pending');
    }

    function toggleMode() {
      mode = mode === 'original' ? 'tokens' : 'original';
      document.getElementById('modeBtn').textContent = mode === 'original' ? 'üëÅÔ∏è Original' : 'üîí Tokens';
      render();
    }

    function exportar() {
      if (entities.some(e => e.status === 'pending')) {
        alert('‚ö†Ô∏è Revisa els pendents (taronja)!');
        return;
      }
      
      let md = textOriginal;
      entities.filter(e => e.status === 'approved').forEach(e => {
        const token = `****${e.type}_${e.id.slice(2)}****`;
        md = md.slice(0, e.start) + token + md.slice(e.end);
      });
      
      // MD
      download(new Blob([md], {type: 'text/markdown'}), 'anonim.md');
      
      // JSON
      const mapping = {
        totalPII: entities.filter(e => e.status === 'approved').length,
        entities: entities.filter(e => e.status === 'approved')
      };
      download(new Blob([JSON.stringify(mapping, null, 2)], {type: 'application/json'}), 'mapping.json');
    }

    function escapeHtml(text) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'};
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    function showProgress(pct, msg) {
      document.getElementById('progress-bar').style.width = pct + '%';
      document.getElementById('progress-text').textContent = msg;
      document.getElementById('status').innerHTML = msg;
      document.getElementById('progress').style.display = 'block';
    }

    function download(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>

  <!-- PDF.js -->
  <script src="https://unpkg.com/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
</body>
</html>
